# Gemma 3 4B LoRA Fine-tuning 평가 보고서

## 개요

| 항목 | 내용 |
|------|------|
| 베이스 모델 | google/gemma-3-4b-it |
| 학습 방법 | QLoRA (4-bit 양자화 + LoRA) |
| 학습 환경 | RunPod RTX 4090 24GB |
| 평가 데이터 | 147개 샘플 (5개 특허) |

## 평가 결과 요약

| 메트릭 | 결과 | 비율 |
|--------|------|------|
| JSON 유효성 | 143/147 | **97.3%** |
| risk_level 정확도 | 135/147 | **91.8%** |
| match 정확도 | 611/643 | **95.0%** |

## risk_level 혼동 행렬

예측 결과와 실제 정답 간의 분포입니다.

|  | 정답: 높음 | 정답: 애매 | 정답: 낮음 |
|--|:--------:|:--------:|:--------:|
| **예측: 높음** | 29 | 1 | 0 |
| **예측: 애매** | 0 | 42 | 1 |
| **예측: 낮음** | 0 | 6 | 64 |

### risk_level 분석

- **높음**: 30개 중 29개 정답 (96.7%)
- **애매**: 49개 중 42개 정답 (85.7%) - 가장 어려운 클래스
- **낮음**: 70개 중 64개 정답 (91.4%)

주요 오류 패턴: "애매" 케이스를 "낮음"으로 예측하는 경향 (6건)

## match 혼동 행렬

구성요소별 대응 판단 결과입니다.

|  | 정답: 대응 | 정답: 판단불가 | 정답: 미대응 |
|--|:--------:|:----------:|:--------:|
| **예측: 대응** | 380 | 1 | 1 |
| **예측: 판단불가** | 6 | 113 | 13 |
| **예측: 미대응** | 1 | 2 | 116 |

## 오류 케이스 분석

### JSON 파싱 실패 (4건)
- 주로 복잡한 화학 성분명이 포함된 케이스에서 발생
- JSON 구조가 불완전하게 생성되는 경우

### risk_level 오류 (8건)
| # | 쿼리 | 예측 | 정답 |
|---|------|------|------|
| 68 | UV 차단 화장품... | 낮음 | 애매 |
| 90 | 폴리아미드계 겔화제 50중량%... | 낮음 | 애매 |
| 95 | 에틸렌다이아민/하이드로제네이티드... | 낮음 | 애매 |
| 96 | ATPA 겔화제 9%... | 낮음 | 애매 |
| 102 | 폴리아미드계 겔화제-ATPA 52%... | 높음 | 애매 |
| 108 | 에틸렌다이아민/하이드로제네이티드... | 애매 | 낮음 |
| 115 | 폴리아미드계 겔화제 8%... | 낮음 | 애매 |
| 131 | 트리에톡시카프릴릴실란에 TiO2... | 낮음 | 애매 |

**패턴**: 경계값(boundary) 케이스에서 "애매"를 "낮음"으로 판단하는 경향

## 학습 설정

```yaml
# LoRA Configuration
r: 16
lora_alpha: 32
lora_dropout: 0.05
target_modules: ["q_proj", "k_proj", "v_proj", "o_proj"]

# Training
num_train_epochs: 3
per_device_train_batch_size: 2
gradient_accumulation_steps: 8
learning_rate: 2e-4
warmup_ratio: 0.03
```

## 핵심 수정 사항

### 문제점
초기 학습에서 `DataCollatorForLanguageModeling(mlm=False)` 사용 시:
- 수동으로 설정한 labels(-100 마스킹)를 덮어씀
- 프롬프트 부분까지 학습하여 hallucination 발생

### 해결책
```python
from transformers import default_data_collator

trainer = Trainer(
    model=model,
    args=training_args,
    train_dataset=tokenized_ds,
    data_collator=default_data_collator,  # labels 보존
)
```

## 결론

1. **4B 모델로도 특허 침해 리스크 평가 태스크에서 91.8% 정확도 달성**
2. JSON 형식 출력이 안정적 (97.3%)
3. "애매" 케이스 판단이 가장 어려움 - 추가 학습 데이터 필요
4. 경계값 케이스에 대한 데이터 보강 권장

---
*생성일: 2026-01-31*
