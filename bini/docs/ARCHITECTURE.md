# BINI 프로젝트 - 시스템 아키텍처

## 1. 전체 구조

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Frontend (React)                          │
│                        로그인 / 채팅 UI / 결과 표시                    │
└──────────────────────────────┬──────────────────────────────────────┘
                               │ REST API
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Backend (FastAPI)                           │
│                                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │
│  │ Auth API    │  │ Chat API    │  │ Analyze API │  │ History API│ │
│  └─────────────┘  └─────────────┘  └──────┬──────┘  └────────────┘ │
└──────────────────────────────────────────┬──────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          Agent Orchestrator                         │
│                      (분석 플로우 제어 + 추가 질문)                    │
└──────────────────────────────────┬──────────────────────────────────┘
                                   │
                 ┌─────────────────┼─────────────────┐
                 ▼                 ▼                 ▼
         ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
         │ Image Flow  │   │ Text Flow   │   │ Question    │
         │ Pipeline    │   │ Pipeline    │   │ Handler     │
         └─────────────┘   └─────────────┘   └─────────────┘
```

---

## 2. Agent Orchestrator

에이전트는 **분석 플로우를 제어**하고 **정보가 부족하면 사용자에게 질문**합니다.

### 2.1 에이전트 역할

```
┌────────────────────────────────────────────────────────────────┐
│                      Agent Orchestrator                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  1. 입력 분석: 이미지인지 텍스트인지 판단                         │
│                                                                │
│  2. 파이프라인 선택: Image Flow 또는 Text Flow                   │
│                                                                │
│  3. 단계별 실행: 각 단계를 순차적으로 실행                        │
│                                                                │
│  4. 정보 부족 감지: 분석에 필요한 정보가 부족한지 판단             │
│                                                                │
│  5. 추가 질문: 부족하면 사용자에게 질문 → 답변 대기               │
│                                                                │
│  6. 결과 종합: 모든 단계 완료 후 최종 결과 생성                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 2.2 에이전트 상태 흐름

```
                    ┌──────────────┐
                    │   시작       │
                    └──────┬───────┘
                           ▼
                    ┌──────────────┐
                    │ 입력 분석    │
                    └──────┬───────┘
                           ▼
              ┌────────────┴────────────┐
              ▼                         ▼
       ┌─────────────┐           ┌─────────────┐
       │ Image Flow  │           │ Text Flow   │
       └──────┬──────┘           └──────┬──────┘
              │                         │
              ▼                         ▼
       ┌─────────────┐           ┌─────────────┐
       │ 분석 진행   │           │ 분석 진행   │
       └──────┬──────┘           └──────┬──────┘
              │                         │
              ▼                         ▼
       ┌─────────────────────────────────────┐
       │        정보 충분한가?                │
       └──────────────┬──────────────────────┘
                      │
           ┌──────────┴──────────┐
           ▼                     ▼
    ┌─────────────┐       ┌─────────────┐
    │  충분함     │       │  부족함     │
    │  → 결과생성 │       │  → 질문하기 │
    └─────────────┘       └──────┬──────┘
                                 │
                                 ▼
                          ┌─────────────┐
                          │ 사용자 답변 │
                          │    대기     │
                          └──────┬──────┘
                                 │
                                 ▼
                          ┌─────────────┐
                          │ 답변 받음   │
                          │ → 분석 재개 │
                          └─────────────┘
```

---

## 3. Image Flow Pipeline

이미지가 입력되었을 때의 처리 플로우입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                       Image Flow Pipeline                        │
└─────────────────────────────────────────────────────────────────┘

     사용자 이미지
          │
          ▼
┌─────────────────┐
│ 1. 이미지 저장  │ → analysis_images 테이블
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 2. 로카르노     │     │  로카르노 분류 모델                  │
│    자동 분류    │ ←── │  (이미지 → 클래스 예측)              │
└────────┬────────┘     │  예: 02-01 (의류), 12-11 (디스플레이)│
         │              └─────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 3. 이미지 RAG   │     │  Vector DB (pgvector)                │
│    (Top 20)     │ ←── │  design_embeddings에서 유사 검색     │
└────────┬────────┘     │  같은 로카르노 클래스 내에서 검색    │
         │              └─────────────────────────────────────┘
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 4. 유사도 모델  │     │  학습된 유사도 모델                  │
│    검증         │ ←── │  (팀원이 학습 진행 중)               │
└────────┬────────┘     │  RAG 결과를 더 정밀하게 검증         │
         │              └─────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 5. 정보 충분?   │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
  충분      부족
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ Agent: 추가질문 │
    │    │ "제품의 용도가  │
    │    │  무엇인가요?"   │
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 사용자 답변     │
    │    └────────┬────────┘
    │             │
    └──────┬──────┘
           ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 6. LLM 답변     │     │  LLM (GPT-4 등)                     │
│    생성         │ ←── │  유사 특허 목록 + 침해 가능성 설명   │
└────────┬────────┘     └─────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 7. 결과 저장    │ → analyses, image_matches 테이블
└─────────────────┘
```

---

## 4. Text Flow Pipeline

텍스트가 입력되었을 때의 처리 플로우입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                        Text Flow Pipeline                        │
└─────────────────────────────────────────────────────────────────┘

     사용자 텍스트
     "tributyl acetylcitrate가
      들어간 미백 크림"
          │
          ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 1. 키워드 추출  │     │  LLM 또는 NER 모델                   │
│                 │ ←── │  핵심 성분, 기능, 용도 추출          │
└────────┬────────┘     └─────────────────────────────────────┘
         │
         │ keywords: ["tributyl acetylcitrate", "미백", "크림"]
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 2. 청구항 RAG   │     │  Vector DB (pgvector)                │
│                 │ ←── │  claim_embeddings에서 유사 검색      │
└────────┬────────┘     └─────────────────────────────────────┘
         │
         │ Top N 청구항
         ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 3. Reranker     │     │  bge-reranker 등                    │
│                 │ ←── │  쿼리-청구항 관련도 재정렬           │
└────────┬────────┘     └─────────────────────────────────────┘
         │
         │ Reranked 청구항
         ▼
┌─────────────────┐
│ 4. 정보 충분?   │
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
  충분      부족
    │         │
    │         ▼
    │    ┌─────────────────┐
    │    │ Agent: 추가질문 │
    │    │ "제품의 구체적  │
    │    │  성분 함량은?"  │
    │    └────────┬────────┘
    │             │
    │             ▼
    │    ┌─────────────────┐
    │    │ 사용자 답변     │
    │    └────────┬────────┘
    │             │
    └──────┬──────┘
           ▼
┌─────────────────┐     ┌─────────────────────────────────────┐
│ 5. sLLM 분석    │     │  Fine-tuned Gemma 1B                │
│                 │ ←── │  청구항별 침해 여부 판단             │
└────────┬────────┘     │  risk_level: 높음/애매/낮음          │
         │              └─────────────────────────────────────┘
         ▼
┌─────────────────┐
│ 6. 결과 저장    │ → analyses, analysis_keywords, claim_matches
└─────────────────┘
```

---

## 5. 에이전트 추가 질문 예시

### 5.1 이미지 분석 시

| 상황 | 질문 |
|------|------|
| 로카르노 분류 애매 | "이 제품은 어떤 용도로 사용되나요? (예: 가전, 가구, 의류)" |
| 유사 특허 많음 | "이 디자인의 가장 특징적인 부분이 어디인가요?" |
| 이미지 품질 낮음 | "더 선명한 이미지를 제공해 주실 수 있나요?" |

### 5.2 텍스트 분석 시

| 상황 | 질문 |
|------|------|
| 성분 정보 부족 | "제품에 포함된 주요 성분을 알려주세요" |
| 용도 불명확 | "이 제품의 주요 용도는 무엇인가요?" |
| 기술 범위 모호 | "이 기술이 적용되는 산업 분야가 어디인가요?" |

---

## 6. 모델 & 서비스 매핑

```
┌─────────────────────────────────────────────────────────────────┐
│                        사용 모델/서비스                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ 로카르노 분류   │ → 이미지 분류 모델 (학습 예정)              │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ 이미지 임베딩   │ → CLIP (OpenAI) 또는 유사 모델             │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ 이미지 유사도   │ → 학습된 유사도 모델 (팀원 진행 중)         │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ 텍스트 임베딩   │ → OpenAI ada-002 또는 KoSimCSE            │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ Reranker        │ → bge-reranker-base                       │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ sLLM (텍스트)   │ → Fine-tuned Gemma 1B (LoRA) ✅ 완료      │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ LLM (이미지)    │ → GPT-4 Vision 또는 Claude                │
│  └─────────────────┘                                           │
│                                                                 │
│  ┌─────────────────┐                                           │
│  │ Agent           │ → LangChain / LangGraph 또는 Custom       │
│  └─────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. 기술 스택 요약

| 레이어 | 기술 |
|--------|------|
| Frontend | React / Next.js |
| Backend | FastAPI (Python) |
| Database | PostgreSQL + pgvector |
| Agent | LangChain / LangGraph |
| sLLM | Gemma 1B + LoRA |
| LLM | GPT-4 / Claude |
| 이미지 임베딩 | CLIP |
| 텍스트 임베딩 | OpenAI ada-002 / KoSimCSE |
| Reranker | bge-reranker |
| 인프라 | Docker, RunPod (GPU) |

---

## 8. 디렉토리 구조 (예정)

```
bini/
├── frontend/           # React 앱
│   ├── src/
│   └── package.json
│
├── backend/            # FastAPI 서버
│   ├── app/
│   │   ├── api/        # 라우터
│   │   ├── core/       # 설정, 보안
│   │   ├── models/     # DB 모델
│   │   ├── schemas/    # Pydantic 스키마
│   │   ├── services/   # 비즈니스 로직
│   │   └── agent/      # 에이전트 오케스트레이터
│   │       ├── orchestrator.py
│   │       ├── image_pipeline.py
│   │       ├── text_pipeline.py
│   │       └── question_handler.py
│   └── requirements.txt
│
├── models/             # ML 모델
│   ├── locarno/        # 로카르노 분류
│   ├── similarity/     # 이미지 유사도
│   └── sllm/           # Fine-tuned Gemma
│
├── data/               # 데이터
│   ├── raw/
│   └── processed/
│
└── docs/               # 문서
    ├── ERD_FINAL.md
    └── ARCHITECTURE.md  # 이 파일
```

---

*이 문서는 시스템 구조를 설명합니다. 데이터베이스 스키마는 ERD_FINAL.md를 참조하세요.*
